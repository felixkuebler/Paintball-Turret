<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="/css/style.css">
        <script src="/js/utils.js"></script>
        <script src="/js/draw.js"></script>
        <meta charset="utf-8" content="noindex,follow">
        <title>Video Streaming</title>
    </head>
    <body>

        <div id="fullScreenDisplay" style="display: none;">
            <img id="fullScreenImage" src="{{ url_for('video_feed') }}">
            <canvas id="fullScreenCanvas"></canvas>
        </div>

        <div class="container-parent">

            <div class="container-parent container-child" style="width:59%; height:100%; position: fixed;">
                <h2>Image & Position Feedback</h2>
                <div class="container-child" style="width:70%; height:100%;" >   
                    <img src="{{ url_for('video_feed') }}" style="width:100%; height: auto;">
                </div>
                <div class="container-child" style="width:28%; height:100%; margin-left:2%;">   
                    <canvas id="positionCanvasX" style="width:100%; "></canvas>
                    <canvas id="positionCanvasY" style="width:100%; "></canvas>
                </div>
            </div>

            <div class="container-child" style="width:39%; height:100%; margin-left:61%;">
                <h2>Control</h2>
                <div>

                    <h3>Activate</h3>
                    <hr>
                    <div id="armButton" class="button">Arm</div>
                    <p class="description">
                        Arm the turret and enter fullscreen mode.<br> 
                        WARNING! The Safety will be disengaged.<br><br>
                        On PC: Use arrow keys for motion control and space bar to trigger. <br>
                        (trigger control is only enabled in fullscreen mode)<br><br>
                        On Mobile: Use screen corners for motion control and screen center to trigger.<br>
                        (all controls are only enabled in fullscreen mode)</p>

                    <h3>Motion (Speed)</h3>
                    <hr>
                    <div style="margin-left: 5%; margin-right:5%; width:90%">
                        X%
                        <input type="range" id="xSpeedInput" min="-100" max="100">
                        <div id="tickmarks">
                            <p>-100</p><p>-90</p><p>-80</p><p>-70</p><p>-60</p><p>-50</p><p>-40</p><p>-30</p><p>-20</p><p>-10</p>
                            <p>0</p>
                            <p>10</p><p>20</p><p>30</p><p>40</p><p>50</p><p>60</p><p>70</p><p>80</p><p>90</p><p>100</p>
                        </div>
                        <br>
                        Y%
                        <input type="range" id="ySpeedInput" min="-100" max="100">
                        <div id="tickmarks">
                            <p>-100</p><p>-90</p><p>-80</p><p>-70</p><p>-60</p><p>-50</p><p>-40</p><p>-30</p><p>-20</p><p>-10</p>
                            <p>0</p>
                            <p>10</p><p>20</p><p>30</p><p>40</p><p>50</p><p>60</p><p>70</p><p>80</p><p>90</p><p>100</p>
                        </div>
                        <br>
                        <p class="description">
                            Manually set speed of X or Y axis. (-100% to 100%)
                        </p>
                    </div>

                    <h3>Motion (Position)</h3>
                    <hr>
                    <div style="margin-left: 5%; margin-right:5%; width:90%">
                        X°
                        <input type="range" id="xPositionInput" min="-90" max="90">
                        <div id="tickmarks">
                            <p>-90</p><p>-80</p><p>-70</p><p>-60</p><p>-50</p><p>-40</p><p>-30</p><p>-20</p><p>-10</p>
                            <p>0</p>
                            <p>10</p><p>20</p><p>30</p><p>40</p><p>50</p><p>60</p><p>70</p><p>80</p><p>90</p>
                        </div>
                        <br>
                        Y°
                        <input type="range" id="yPositionInput" min="-50" max="50">
                        <div id="tickmarks">
                            <p>-50</p><p>-40</p><p>-30</p><p>-20</p><p>-10</p>
                            <p>0</p>
                            <p>10</p><p>20</p><p>30</p><p>40</p><p>50</p>
                        </div>
                        <br>
                        <p class="description">
                            Manually set Position of X or Y axis.</br>
                            For X axis -90° to 90°. For Y axis -45° to 45°.
                        </p>
                    </div>


                    <h3>Calibrate</h3>
                    <hr>
                    <div id="resetButtonX" class="button">Reset X</div> 
                    <div id="resetButtonY" class="button">Reset Y</div> 
                    <p class="description">
                        Reset X or Y axis position to 0.<br>
                        This is used for rehomeing the device.
                    </p>
                </div>
            </div>
        </div>

    <script >

        // <img id="fullScreenImage" src="../static/img/testImage.gif">
        // <img id="fullScreenImage" src="{{ url_for('video_feed') }}">
        // <img src="../static/img/testImage.gif" style="width:100%; height: auto;">
        // <img src="{{ url_for('video_feed') }}" style="width:100%; height: auto;">

        const imageBottomX = new Image();
        imageBottomX.src = "/img/turretStaticX.png";

        const imageTopX = new Image();
        imageTopX.src = "/img/turretDynamicX.png";


        const imageBottomY = new Image();
        imageBottomY.src = "/img/turretDynamicY.png";

        const imageTopY = new Image();
        imageTopY.src = "/img/turretStaticY.png";

        const imageTopYCamera = new Image();
        imageTopYCamera.src = "/img/turretDynamicYCamera.png";


        // html objects        
        const armButton = document.getElementById("armButton");

        const resetButtonX = document.getElementById("resetButtonX");
        const resetButtonY = document.getElementById("resetButtonY");

        const xSpeedInput = document.getElementById("xSpeedInput");
        const ySpeedInput = document.getElementById("ySpeedInput");

        const xPositionInput = document.getElementById("xPositionInput");
        const yPositionInput = document.getElementById("yPositionInput");

        const fullScreenDisplay = document.getElementById("fullScreenDisplay");
        const fullScreenImage = document.getElementById("fullScreenImage");
        const fullScreenCanvas = document.getElementById("fullScreenCanvas");

        const positionCanvasX = document.getElementById("positionCanvasX");
        const positionCanvasY = document.getElementById("positionCanvasY");

        const mouseSpeedFactorX = 20;
        const mouseSpeedFactorY = 20;

        var xPosFeedback = 0;
        var yPosFeedback = 0;

        // iinput variables
        var xSpeed = 0;
        var ySpeed = 0;
        var xLastSpeed = 0;
        var yLastSpeed = 0;

        var triggered = false;

        // readback variables
        var xPosFeedback = 0;
        var yPosFeedback = 0;

        // keabouard and mouse input
        var mouseIsMovingX = false;
        var mouseIsMovingY = false;

        // up - down - left - right - space
        var keyMap = {38: false, 40: false, 37: false, 39: false, 32: false};

        // topRight - bottomRight - topLeft - bottomLeft - center
        var mouchMap = {1: false, 2: false, 3: false, 4: false, 5: false};



        function refreshAnimations(){
            if (document.fullscreenElement){

                enableFullScreen(fullScreenDisplay, fullScreenImage, fullScreenCanvas);

                var ctx = fullScreenCanvas.getContext('2d');
                ctx.globalAlpha = 1;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                drawPositionFeedbackFullScreen(ctx, xPosFeedback, -yPosFeedback);
                drawCrosshair(ctx);

                if (triggered) {
                    drawTriggerToggle(ctx);
                    triggered = false;
                }
            }
            else
            {
                disableFullScreen(fullScreenDisplay, fullScreenImage, fullScreenCanvas);
                drawPositionFeebackOverview(positionCanvasX, positionCanvasY, xPosFeedback, yPosFeedback);
            }
        };
        window.setInterval("refreshAnimations()", 50); 


        function armButtonClickCallback(){
            if(fullScreenDisplay.webkitRequestFullScreen) {
                fullScreenDisplay.webkitRequestFullScreen();
            } else {
                fullScreenDisplay.mozRequestFullScreen();
            }
        }
        armButton.addEventListener("click",armButtonClickCallback);


        function resetButtonXClickCallback(){
            httpPostAsync("{{ url_for('option') }}", "{\"resetPosX\":\"1\"}");
        }
        resetButtonX.addEventListener("click",resetButtonXClickCallback);


        function resetButtonYClickCallback(){
            httpPostAsync("{{ url_for('option') }}", "{\"resetPosY\":\"1\"}");
        }
        resetButtonY.addEventListener("click",resetButtonYClickCallback);


        function xSpeedInputChangeCallback(event){
            var postString = "{\"xSpeed\":" + event.target.value + "}";
            httpPostAsync("{{ url_for('controlle') }}", postString);
        }
        xSpeedInput.addEventListener("mouseup",xSpeedInputChangeCallback);
        xSpeedInput.addEventListener("touchend",xSpeedInputChangeCallback);


        function ySpeedInputChangeCallback(event){
            var postString = "{\"ySpeed\":" + event.target.value + "}";
            httpPostAsync("{{ url_for('controlle') }}", postString);
        }
        ySpeedInput.addEventListener("mouseup",ySpeedInputChangeCallback);
        ySpeedInput.addEventListener("touchend",ySpeedInputChangeCallback);


        function xPositionInputChangeCallback(event){
            var postString = "{\"xPos\":" + event.target.value + "}";
            httpPostAsync("{{ url_for('controlle') }}", postString);
        }
        xPositionInput.addEventListener("mouseup",xPositionInputChangeCallback);
        xPositionInput.addEventListener("touchend",xPositionInputChangeCallback);


        function yPositionInputChangeCallback(event){
            var postString = "{\"yPos\":" + event.target.value + "}";
            httpPostAsync("{{ url_for('controlle') }}", postString);
        }
        yPositionInput.addEventListener("mouseup",yPositionInputChangeCallback);
        yPositionInput.addEventListener("touchend",yPositionInputChangeCallback);


        function displayPressedCallback(event){
            if (document.fullscreenElement) {
                var x = event.changedTouches[0].pageX;
                var y = event.changedTouches[0].pageY;

                var w = window.screen.width;
                var h = window.screen.height;

                if ( x > w/5*4 && y<h/2) mouchMap[1] = true;
                if ( x > w/5*4 && y>h/2) mouchMap[2] = true;
                if ( x < w/5 && y<h/2) mouchMap[3] = true;
                if ( x < w/5 && y>h/2) mouchMap[4] = true;
                if ( x > w/5 && x<w/5*4) mouchMap[5] = true;

                if (mouchMap[5]){
                    httpPostAsync("{{ url_for('controlle') }}", "{\"trigger\":\"1\"}");
                    triggered = true;
                }
            }

        }
        fullScreenDisplay.addEventListener('touchstart',displayPressedCallback);


        function displayReleaseCallback(event){

            if (document.fullscreenElement) {
                var x = event.changedTouches[0].pageX;
                var y = event.changedTouches[0].pageY;

                var w = window.screen.width;
                var h = window.screen.height;

                if ( x > w/4*3 && y<h/2) mouchMap[1] = false;
                if ( x > w/4*3 && y>h/2) mouchMap[2] = false;
                if ( x < w/4 && y<h/2) mouchMap[3] = false;
                if ( x < w/4 && y>h/2) mouchMap[4] = false;
                if ( x > w/4 && x<w/4*3) mouchMap[5] = false;
            }
        }
        fullScreenDisplay.addEventListener('touchend',displayReleaseCallback);


        function keyboardPressCallback(event){
            if (event.keyCode in keyMap) {
                keyMap[event.keyCode] = true;
            }

            // trigger only on button down one
            if (document.fullscreenElement && keyMap[32]) {
                httpPostAsync("{{ url_for('controlle') }}", "{\"trigger\":\"1\"}");
                triggered = true;
            }
        }
        window.addEventListener('keydown',keyboardPressCallback);


        function keyboardReleaseCallback(event){
            if (event.keyCode in keyMap) {
                keyMap[event.keyCode] = false;
            }
        }
        window.addEventListener('keyup',keyboardReleaseCallback);


        function controlleTimeoutCallback(){

            if (!mouseIsMovingX){
                xSpeed = 0;
            }
            if (!mouseIsMovingY){
                ySpeed = 0;
            }

            // left, not right arrow
            if ((keyMap[37] && !keyMap[39]) || (mouchMap[4] && !mouchMap[3])){
                xSpeed = -40;
            }
            // right, not right arrow
            if (keyMap[39] && !keyMap[37] || (mouchMap[3] && !mouchMap[4])){
                xSpeed = 40;
            }
            // up, not down arrow
            if (keyMap[38] && !keyMap[40] || (mouchMap[1] && !mouchMap[2])){
                ySpeed = -45  ;
            }
            // down, not up arrow
            if (keyMap[40] && !keyMap[38] || (mouchMap[2] && !mouchMap[1])){            
                ySpeed = 45;
            }

            if (xSpeed != xLastSpeed){
                xLastSpeed = xSpeed;
                var postString = "{\"xSpeed\":" + xSpeed + "}";
                console.log("xSpeed=" + xSpeed);
                httpPostAsync("{{ url_for('controlle') }}", postString);
            }
            if (ySpeed != yLastSpeed){
                yLastSpeed = ySpeed;
                var postString = "{\"ySpeed\":" + -ySpeed + "}";
                console.log("ySpeed=" + ySpeed);
                httpPostAsync("{{ url_for('controlle') }}", postString);
            }
        };
        window.setInterval(controlleTimeoutCallback, 50); 


/*
        function fullScreenDisplayClickCallback(){  
            if (document.fullscreenElement){
                httpPostAsync("{{ url_for('controlle') }}", "{\"trigger\":\"1\"}");
                triggered = true;
            }
        }
        fullScreenDisplay.addEventListener("click",fullScreenDisplayClickCallback);


        function fullScreenDisplayMouseMoveCallback(event){
            if (document.fullscreenElement) {

                xSpeed = (event.movementX*mouseSpeedFactorX);

                if (xSpeed != 0) mouseIsMovingX = true;
                else mouseIsMovingX = false;

                if (xSpeed > 100) xSpeed = 100;
                else if (xSpeed < -100) xSpeed = -100;

                ySpeed = (event.movementY*mouseSpeedFactorY);

                if (ySpeed != 0) mouseIsMovingY = true;
                else mouseIsMovingY = false;

                if (ySpeed > 100) ySpeed = 100;
                else if (ySpeed < -100) ySpeed = -100;
            }
        }
        fullScreenDisplay.addEventListener('mousemove',fullScreenDisplayMouseMoveCallback);


        function fullScreenDisplayMouseMoveResetCallback(){
            mouseIsMovingX = false;
            mouseIsMovingY = false;
        };
        window.setInterval(fullScreenDisplayMouseMoveResetCallback, 100); 
*/

        function refreshPosition(){
            httpGetAsync("{{ url_for('feedback') }}", "position=1", null, positionCallback)
        };
        function positionCallback(response){        
            var responseObj = JSON.parse(response);
            xPosFeedback = parseFloat(responseObj.xPos);
            yPosFeedback = parseFloat(responseObj.yPos);
        };
       window.setInterval("refreshPosition()", 200); 

    </script>
    </body>
</html>